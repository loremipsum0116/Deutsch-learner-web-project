// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  // PlanetScale 쓰는 경우 "prisma", 로컬 MySQL이면 "foreignKeys"
  relationMode = "foreignKeys"
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  role         String   @default("USER")
  profile      Json?
  createdAt    DateTime @default(now())
  lastStudiedAt DateTime?
  streak        Int       @default(0)

  SRSCard  SRSCard[]
  TutorLog TutorLog[]
  myVocab  UserVocab[]

  // ★ 추가: Category 역방향 필드(백릴레이션)
  categories Category[]
}

model Category {
  id        Int      @id @default(autoincrement())
  userId    Int
  name      String   // 폴더 이름 (예: "2025-08-08 복습")
  createdAt DateTime @default(now())

  // "wordbook" 또는 "srs" (SRS 복습 폴더용)
  kind        String    @default("wordbook") 
  // 알림 관련 필드
  nextAlarmAt DateTime?
  alarmActive Boolean   @default(true) 
  remindEvery Int?

  items    UserVocab[]
  srsCards SRSCard[]   // 카테고리에 직접 SRS 카드 연결

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model Vocab {
  id        Int     @id @default(autoincrement())
  lemma     String  @unique
  pos       String
  plural    String?
  levelCEFR String
  freq      Int?
  source    String? // 'seed-A1', 'wiktionary' 등

  dictMeta     DictEntry?
  savedByUsers UserVocab[]

  @@index([lemma])
  @@index([source])
}

model DictEntry {
  id          Int       @id @default(autoincrement())
  vocabId     Int       @unique
  ipa         String?
  audioUrl    String?
  audioLocal  String?
  license     String?
  attribution String?
  sourceUrl   String?
  retrievedAt DateTime?
  examples    Json
  ipaKo       String?

  Vocab Vocab @relation(fields: [vocabId], references: [id], onDelete: Cascade)
}

model GrammarItem {
  id       Int    @id @default(autoincrement())
  topic    String
  rule     String
  examples Json
}

model GrammarExercise {
  id        Int    @id @default(autoincrement())
  topicId   String @unique // ★ 수정: topicId 추가 및 unique 설정
  topic     String
  levelCEFR String
  items     Json
}

model Reading {
  id        Int    @id @default(autoincrement())
  title     String
  body      String
  levelCEFR String
  glosses   Json
}

model SessionBatch {
  id        Int      @id @default(autoincrement())
  userId    Int
  createdAt DateTime @default(now())
  order     Int
  cards     Json
}

model SRSCard {
  id             Int       @id @default(autoincrement())
  userId         Int
  itemType       String    // "vocab"
  itemId         Int
  stage          Int       @default(0)
  nextReviewAt   DateTime  @default(now())
  lastResult     String?   // "pass" 또는 "fail"
  createdAt      DateTime  @default(now())
  active         Boolean   @default(true)
  updatedAt      DateTime  @updatedAt // 마지막 학습일 추적
  correctCount   Int       @default(0)
  incorrectCount Int       @default(0) // 오답 횟수 누적

  // SRS 카드를 폴더(Category)에 할당
  categoryId     Int?
  category       Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  User User @relation(fields: [userId], references: [id])

  @@unique([userId, itemId, itemType])
  @@index([userId, itemType, nextReviewAt])
}


model TutorLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  mode      String
  input     String
  output    String
  tokens    Int?
  cost      Float?
  refs      Json?
  createdAt DateTime @default(now())

  User User @relation(fields: [userId], references: [id])
}

model UserVocab {
  id        Int      @id @default(autoincrement())
  userId    Int
  vocabId   Int
  createdAt DateTime @default(now())

  // ★ 폴더(카테고리) 연결(선택)
  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocab Vocab @relation(fields: [vocabId], references: [id], onDelete: Cascade)

  @@unique([userId, vocabId])
  @@index([userId, categoryId])
}
